#!/usr/bin/env python3
# FastAPI backend exposing minimal endpoints to reuse your core functions.
# Save as scripts/api.py

try:\n    # python-multipart is required for FastAPI to accept UploadFile/Form fields\n    import multipart  # type: ignore\nexcept Exception:\n    raise RuntimeError(\n        'Missing dependency: python-multipart. Install with `pip install python-multipart`'\n    )\n\nfrom fastapi import FastAPI, UploadFile, File, Form
from fastapi.staticfiles import StaticFiles
from fastapi.responses import FileResponse, JSONResponse
import os
from pathlib import Path
from core.blender_export import export_highpoly
from core.blender_script_export import generate_blender_script
import shutil
import uuid

app = FastAPI(title="DesignTranslator API")

ROOT = Path(__file__).resolve().parents[1]
TMP_DIR = ROOT / "tmp"
STATIC_DIR = ROOT / "frontend_dist"
TMP_DIR.mkdir(exist_ok=True)
STATIC_DIR.mkdir(exist_ok=True)

if STATIC_DIR.exists():
    app.mount("/", StaticFiles(directory=str(STATIC_DIR), html=True), name="frontend")


@app.post("/api/export")
async def export_endpoint(file: UploadFile = File(...), name: str = Form(default="export")):
    uid = uuid.uuid4().hex
    workdir = TMP_DIR / uid
    workdir.mkdir(parents=True, exist_ok=True)
    input_path = workdir / file.filename
    with open(input_path, "wb") as f:
        shutil.copyfileobj(file.file, f)
    try:
        out = export_highpoly(str(input_path), str(workdir), name=name)
        return FileResponse(str(out), media_type="application/octet-stream", filename=os.path.basename(out))
    except Exception as e:
        return JSONResponse({"error": str(e)}, status_code=500)


@app.post("/api/generate_script")
async def script_endpoint(file: UploadFile = File(...), name: str = Form(default="import_script")):
    uid = uuid.uuid4().hex
    workdir = TMP_DIR / uid
    workdir.mkdir(parents=True, exist_ok=True)
    input_path = workdir / file.filename
    with open(input_path, "wb") as f:
        shutil.copyfileobj(file.file, f)
    try:
        stl_path = str(input_path)
        if input_path.suffix.lower() != ".stl":
            stl_path = export_highpoly(str(input_path), str(workdir), name=f"{name}_for_blender")
        script = generate_blender_script(stl_path, str(workdir), name=name)
        return FileResponse(script, media_type="text/x-python", filename=os.path.basename(script))
    except Exception as e:
        return JSONResponse({"error": str(e)}, status_code=500)
